---
interface Props {
	as?: keyof HTMLElementTagNameMap;
	class?: string;
	delay?: number;
}

const {
	as = 'div',
	class: className = '',
	delay = 0,
	...rest
} = Astro.props as Props & Record<string, unknown>;
const Tag = as;
---

<Tag
	data-reveal
	data-reveal-delay={delay}
	class={`reveal ${className}`.trim()}
	{...rest}
>
	<slot />
</Tag>

<style>
	:global(.reveal) {
		opacity: 0;
		transform: translateY(32px);
		transition:
			opacity 700ms cubic-bezier(0.22, 1, 0.36, 1),
			transform 700ms cubic-bezier(0.22, 1, 0.36, 1);
	}

	:global(.reveal.is-visible) {
		opacity: 1;
		transform: translateY(0);
	}
</style>

<script is:inline>
	(() => {
		if (typeof window === 'undefined') return;
		if (window.__revealInit) return;

		window.__revealInit = true;

		const init = () => {
			const elements = Array.from(document.querySelectorAll('[data-reveal]'));
			if (!elements.length) return;

			const observer = new IntersectionObserver(
				(entries) => {
					for (const entry of entries) {
						if (!entry.isIntersecting) continue;
						const delay =
							Number(entry.target.getAttribute('data-reveal-delay')) || 0;
						window.setTimeout(
							() => entry.target.classList.add('is-visible'),
							delay
						);
						observer.unobserve(entry.target);
					}
				},
				{ threshold: 0.2 }
			);

			elements.forEach((el) => observer.observe(el));
		};

		if (document.readyState === 'loading') {
			document.addEventListener('DOMContentLoaded', init, { once: true });
		} else {
			init();
		}
	})();
</script>
